name: Build and Push to ACR

on:
  push:
    branches: [master]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Login to ACR
        uses: docker/login-action@v3
        with:
          registry: coen314a2acr.azurecr.io
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and push api-gateway
        run: |
          docker build --platform linux/amd64 -t coen314a2acr.azurecr.io/api-gateway:${{ github.sha }} -t coen314a2acr.azurecr.io/api-gateway:latest ./Server/api_gateway
          docker push coen314a2acr.azurecr.io/api-gateway --all-tags

      - name: Build and push user-v1
        run: |
          docker build --platform linux/amd64 -t coen314a2acr.azurecr.io/user-v1:${{ github.sha }} -t coen314a2acr.azurecr.io/user-v1:latest ./Server/user_V1
          docker push coen314a2acr.azurecr.io/user-v1 --all-tags

      - name: Build and push user-v2
        run: |
          docker build --platform linux/amd64 -t coen314a2acr.azurecr.io/user-v2:${{ github.sha }} -t coen314a2acr.azurecr.io/user-v2:latest ./Server/user_V2
          docker push coen314a2acr.azurecr.io/user-v2 --all-tags

      - name: Build and push order
        run: |
          docker build --platform linux/amd64 -t coen314a2acr.azurecr.io/order:${{ github.sha }} -t coen314a2acr.azurecr.io/order:latest ./Server/order
          docker push coen314a2acr.azurecr.io/order --all-tags

      - name: Build and push event
        run: |
          docker build --platform linux/amd64 -t coen314a2acr.azurecr.io/event:${{ github.sha }} -t coen314a2acr.azurecr.io/event:latest ./Server/event
          docker push coen314a2acr.azurecr.io/event --all-tags

      - name: Update Container Apps
        run: |
          az login --service-principal -u ${{ secrets.AZURE_CLIENT_ID }} -p ${{ secrets.AZURE_CLIENT_SECRET }} --tenant ${{ secrets.AZURE_TENANT_ID }}
          az containerapp update --name user-v1 --resource-group rg-coen314-a2 --image coen314a2acr.azurecr.io/user-v1:${{ github.sha }}
          az containerapp update --name user-v2 --resource-group rg-coen314-a2 --image coen314a2acr.azurecr.io/user-v2:${{ github.sha }}
          az containerapp update --name order --resource-group rg-coen314-a2 --image coen314a2acr.azurecr.io/order:${{ github.sha }}
          az containerapp update --name event --resource-group rg-coen314-a2 --image coen314a2acr.azurecr.io/event:${{ github.sha }}
          az containerapp update --name api-gateway --resource-group rg-coen314-a2 --image coen314a2acr.azurecr.io/api-gateway:${{ github.sha }}