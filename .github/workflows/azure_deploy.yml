name: Build and Deploy to Azure Container Apps

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  ACR_NAME: coen314a2acr
  RESOURCE_GROUP: rg-coen314-a2
  ENVIRONMENT: coen314-env

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_NAME }}.azurecr.io
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Build and push api-gateway
      - name: Build and push api-gateway
        uses: docker/build-push-action@v5
        with:
          context: ./Server/api_gateway
          platforms: linux/amd64
          push: true
          tags: ${{ env.ACR_NAME }}.azurecr.io/api-gateway:${{ github.sha }}

      # Build and push event
      - name: Build and push event
        uses: docker/build-push-action@v5
        with:
          context: ./Server/event
          platforms: linux/amd64
          push: true
          tags: ${{ env.ACR_NAME }}.azurecr.io/event:${{ github.sha }}

      # Build and push order
      - name: Build and push order
        uses: docker/build-push-action@v5
        with:
          context: ./Server/order
          platforms: linux/amd64
          push: true
          tags: ${{ env.ACR_NAME }}.azurecr.io/order:${{ github.sha }}

      # Build and push user-v1
      - name: Build and push user-v1
        uses: docker/build-push-action@v5
        with:
          context: ./Server/user_V1
          platforms: linux/amd64
          push: true
          tags: ${{ env.ACR_NAME }}.azurecr.io/user-v1:${{ github.sha }}

      # Build and push user-v2
      - name: Build and push user-v2
        uses: docker/build-push-action@v5
        with:
          context: ./Server/user_V2
          platforms: linux/amd64
          push: true
          tags: ${{ env.ACR_NAME }}.azurecr.io/user-v2:${{ github.sha }}

      # Deploy to Container Apps
      - name: Deploy api-gateway
        uses: azure/cli@v1
        with:
          inlineScript: |
            az containerapp update \
              --name api-gateway \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --image ${{ env.ACR_NAME }}.azurecr.io/api-gateway:${{ github.sha }}

      - name: Deploy event
        uses: azure/cli@v1
        with:
          inlineScript: |
            az containerapp update \
              --name event \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --image ${{ env.ACR_NAME }}.azurecr.io/event:${{ github.sha }}

      - name: Deploy order
        uses: azure/cli@v1
        with:
          inlineScript: |
            az containerapp update \
              --name order \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --image ${{ env.ACR_NAME }}.azurecr.io/order:${{ github.sha }}

      - name: Deploy user-v1
        uses: azure/cli@v1
        with:
          inlineScript: |
            az containerapp update \
              --name user-v1 \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --image ${{ env.ACR_NAME }}.azurecr.io/user-v1:${{ github.sha }}

      - name: Deploy user-v2
        uses: azure/cli@v1
        with:
          inlineScript: |
            az containerapp update \
              --name user-v2 \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --image ${{ env.ACR_NAME }}.azurecr.io/user-v2:${{ github.sha }}
